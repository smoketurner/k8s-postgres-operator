# PostgresCluster with AWS S3 backup configuration
#
# This example demonstrates continuous archiving to AWS S3 with:
# - Daily base backups at 2 AM
# - Continuous WAL archiving for point-in-time recovery
# - 7 backup retention policy
# - Zstandard compression for better compression ratio
#
# Prerequisites:
# 1. Create the credentials secret:
#    kubectl create secret generic aws-backup-credentials \
#      --from-literal=AWS_ACCESS_KEY_ID=<your-access-key> \
#      --from-literal=AWS_SECRET_ACCESS_KEY=<your-secret-key>
#
# 2. Create an S3 bucket with appropriate permissions
#
apiVersion: postgres-operator.smoketurner.com/v1alpha1
kind: PostgresCluster
metadata:
  name: production-with-backup
spec:
  version: "16"
  replicas: 3

  storage:
    size: 100Gi
    storageClass: fast-ssd

  # TLS disabled for simplicity; enable for production
  tls:
    enabled: false

  resources:
    requests:
      cpu: "1"
      memory: "2Gi"
    limits:
      cpu: "2"
      memory: "4Gi"

  backup:
    # Cron schedule for base backups (daily at 2 AM)
    schedule: "0 2 * * *"

    # Keep 7 most recent backups
    retention:
      count: 7
      maxAge: "30d"

    # AWS S3 destination
    destination:
      type: S3
      bucket: my-postgres-backups
      region: us-east-1
      credentialsSecret: aws-backup-credentials
      # Optional: custom path prefix (default: namespace/cluster-name)
      # path: backups/production

    # Compression method: lz4 (fast), zstd (balanced), lzma (max compression)
    compression: zstd

    # Take backups from replica to reduce primary load
    backupFromReplica: true

    # Parallel upload streams for faster backups
    uploadConcurrency: 16

---
# The credentials secret referenced above
# In production, use sealed secrets, external secrets, or vault
apiVersion: v1
kind: Secret
metadata:
  name: aws-backup-credentials
type: Opaque
stringData:
  AWS_ACCESS_KEY_ID: "AKIAIOSFODNN7EXAMPLE"
  AWS_SECRET_ACCESS_KEY: "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
