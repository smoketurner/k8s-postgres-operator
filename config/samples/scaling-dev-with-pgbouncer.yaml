# Development cluster with scale-to-zero and PgBouncer for connection queuing
# Better handling of connections during wake-up (PgBouncer queues while DB starts)
#
# KEDA Resources Created:
# - HTTPScaledObject: Targets PgBouncer Deployment for connection interception
# - ScaledObject: Scales StatefulSet based on PgBouncer client activity
#
# Requirements:
# - KEDA installed with HTTP Add-on
# - Prometheus (for PgBouncer metrics-based scaling of StatefulSet)
#
# Test Scenario:
# 1. Apply this manifest
# 2. Wait for cluster to start (kubectl get pgc dev-db-pooled -w)
# 3. Connect via PgBouncer service (dev-db-pooled-pgbouncer:5432)
# 4. Note: Connections queue in PgBouncer during wake-up instead of failing
# 5. Disconnect and wait for idle timeout
# 6. Verify StatefulSet scales to 0
# 7. Reconnect - PgBouncer accepts connection while PostgreSQL wakes up
apiVersion: postgres-operator.smoketurner.com/v1alpha1
kind: PostgresCluster
metadata:
  name: dev-db-pooled
  namespace: default
  labels:
    environment: development
spec:
  version: "17"
  replicas: 1
  storage:
    size: 5Gi
  resources:
    requests:
      cpu: "250m"
      memory: "512Mi"
    limits:
      cpu: "1"
      memory: "1Gi"
  tls:
    enabled: false
  # PgBouncer for connection queuing during scale-from-zero
  pgbouncer:
    enabled: true
    replicas: 1           # Minimal for development
    poolMode: transaction
    maxDbConnections: 20
    defaultPoolSize: 10
    maxClientConn: 100
    resources:
      requests:
        cpu: "50m"
        memory: "64Mi"
      limits:
        cpu: "200m"
        memory: "128Mi"
  # Scale-to-zero with PgBouncer integration
  scaling:
    minReplicas: 0
    maxReplicas: 1
    idleTimeout: 15m     # Shorter idle timeout for dev
    wakeupTimeout: 10m   # Longer wake-up window since PgBouncer queues
