# PostgresCluster with Google Cloud Storage backup configuration
#
# This example demonstrates continuous archiving to GCS with:
# - Daily base backups at 3 AM
# - Continuous WAL archiving for point-in-time recovery
# - 14 backup retention policy
#
# Prerequisites:
# 1. Create a GCS bucket
# 2. Create a service account with Storage Object Admin role on the bucket
# 3. Download the service account key JSON and create a secret:
#
#    kubectl create secret generic gcs-backup-credentials \
#      --from-file=GOOGLE_APPLICATION_CREDENTIALS=./service-account.json
#
apiVersion: postgres.example.com/v1alpha1
kind: PostgresCluster
metadata:
  name: production-gcs-backup
spec:
  version: "16"
  replicas: 3

  storage:
    size: 100Gi
    storageClass: standard-rwo

  resources:
    requests:
      cpu: "1"
      memory: "2Gi"
    limits:
      cpu: "2"
      memory: "4Gi"

  backup:
    # Cron schedule for base backups (daily at 3 AM)
    schedule: "0 3 * * *"

    # Keep 14 most recent backups
    retention:
      count: 14

    # Google Cloud Storage destination
    destination:
      type: GCS
      bucket: my-postgres-backups-gcs
      credentialsSecret: gcs-backup-credentials
      # Optional: custom path prefix
      # path: backups/production

    # Use LZ4 compression (fast with good ratio)
    compression: lz4

    # Higher upload concurrency for GCS
    uploadConcurrency: 20

---
# The credentials secret containing the GCS service account JSON
# The key MUST be named 'GOOGLE_APPLICATION_CREDENTIALS'
apiVersion: v1
kind: Secret
metadata:
  name: gcs-backup-credentials
type: Opaque
stringData:
  # Replace with your actual service account JSON content
  GOOGLE_APPLICATION_CREDENTIALS: |
    {
      "type": "service_account",
      "project_id": "your-project-id",
      "private_key_id": "key-id",
      "private_key": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n",
      "client_email": "postgres-backup@your-project.iam.gserviceaccount.com",
      "client_id": "123456789",
      "auth_uri": "https://accounts.google.com/o/oauth2/auth",
      "token_uri": "https://oauth2.googleapis.com/token"
    }
