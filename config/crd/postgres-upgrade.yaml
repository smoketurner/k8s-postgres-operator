apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: postgresupgrades.postgres-operator.smoketurner.com
spec:
  group: postgres-operator.smoketurner.com
  names:
    kind: PostgresUpgrade
    listKind: PostgresUpgradeList
    plural: postgresupgrades
    singular: postgresupgrade
    shortNames:
      - pgup
      - pgupgrade
    categories:
      - databases
      - postgresql
      - all
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Source
          type: string
          jsonPath: .spec.sourceCluster.name
        - name: TargetVer
          type: string
          jsonPath: .spec.targetVersion
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Lag
          type: string
          jsonPath: .status.replication.lagSeconds
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            spec:
              type: object
              required:
                - sourceCluster
                - targetVersion
              x-kubernetes-validations:
                # Replication lag threshold must be non-negative
                - rule: "!has(self.strategy) || !has(self.strategy.preChecks) || self.strategy.preChecks.maxReplicationLagSeconds >= 0"
                  message: "maxReplicationLagSeconds must be non-negative"
                # Row count tolerance must be non-negative
                - rule: "!has(self.strategy) || !has(self.strategy.preChecks) || self.strategy.preChecks.rowCountTolerance >= 0"
                  message: "rowCountTolerance must be non-negative"
                # Minimum verification passes must be at least 1
                - rule: "!has(self.strategy) || !has(self.strategy.preChecks) || self.strategy.preChecks.minVerificationPasses >= 1"
                  message: "minVerificationPasses must be at least 1"
              properties:
                sourceCluster:
                  type: object
                  description: Reference to the source PostgresCluster to upgrade
                  required:
                    - name
                  properties:
                    name:
                      type: string
                      description: Name of the source PostgresCluster
                      minLength: 1
                    namespace:
                      type: string
                      description: Namespace of the source PostgresCluster (defaults to same namespace)
                targetVersion:
                  type: string
                  description: Target PostgreSQL major version
                  enum:
                    - "15"
                    - "16"
                    - "17"
                targetClusterOverrides:
                  type: object
                  description: Optional overrides for the target cluster configuration
                  properties:
                    name:
                      type: string
                      description: Custom name for the target cluster (defaults to source-v{version})
                    replicas:
                      type: integer
                      description: Number of replicas for target cluster (defaults to source)
                      minimum: 1
                      maximum: 9
                    resources:
                      type: object
                      description: Resource requirements for target cluster
                      properties:
                        requests:
                          type: object
                          properties:
                            cpu:
                              type: string
                            memory:
                              type: string
                        limits:
                          type: object
                          properties:
                            cpu:
                              type: string
                            memory:
                              type: string
                strategy:
                  type: object
                  description: Upgrade strategy configuration
                  properties:
                    strategyType:
                      type: string
                      description: Type of upgrade strategy
                      default: BlueGreen
                      enum:
                        - BlueGreen
                    cutover:
                      type: object
                      description: Cutover configuration
                      properties:
                        mode:
                          type: string
                          description: Cutover mode (Manual requires annotation to trigger)
                          default: Manual
                          enum:
                            - Manual
                            - Automatic
                        allowedWindow:
                          type: object
                          description: Optional maintenance window for automatic cutover
                          properties:
                            startTime:
                              type: string
                              description: Start time in HH:MM format
                              pattern: "^[0-2][0-9]:[0-5][0-9]$"
                            endTime:
                              type: string
                              description: End time in HH:MM format
                              pattern: "^[0-2][0-9]:[0-5][0-9]$"
                            timezone:
                              type: string
                              description: Timezone (default UTC)
                              default: UTC
                    preChecks:
                      type: object
                      description: Pre-cutover verification requirements
                      properties:
                        maxReplicationLagSeconds:
                          type: integer
                          description: Maximum replication lag in seconds before cutover (0 for strictest)
                          default: 0
                          minimum: 0
                        minVerificationPasses:
                          type: integer
                          description: Number of consecutive verification passes required
                          default: 3
                          minimum: 1
                        verificationInterval:
                          type: string
                          description: Time between verification checks
                          default: "1m"
                        requireBackupWithin:
                          type: string
                          description: Require a backup within this duration before cutover
                          default: "1h"
                        drainConnectionsTimeout:
                          type: string
                          description: Timeout for draining connections before cutover
                          default: "5m"
                        rowCountTolerance:
                          type: integer
                          description: Allowed row count difference between source and target
                          default: 0
                          minimum: 0
                    timeouts:
                      type: object
                      description: Phase timeout configuration
                      properties:
                        targetClusterReady:
                          type: string
                          description: Timeout for target cluster to become ready
                          default: "30m"
                        initialSync:
                          type: string
                          description: Timeout for initial data sync
                          default: "24h"
                        replicationCatchup:
                          type: string
                          description: Timeout for replication to catch up
                          default: "1h"
                        verification:
                          type: string
                          description: Timeout for verification phase
                          default: "30m"
                        cutover:
                          type: string
                          description: Timeout for cutover phase
                          default: "15m"
                    postCutover:
                      type: object
                      description: Post-cutover configuration
                      properties:
                        healthCheckDuration:
                          type: string
                          description: Duration to monitor health after cutover
                          default: "5m"
                        cleanupSourceCluster:
                          type: boolean
                          description: Whether to delete source cluster after successful upgrade
                          default: false
            status:
              type: object
              properties:
                phase:
                  type: string
                  description: Current phase of the upgrade
                  enum:
                    - Pending
                    - CreatingTarget
                    - ConfiguringReplication
                    - Replicating
                    - Verifying
                    - SyncingSequences
                    - ReadyForCutover
                    - WaitingForManualCutover
                    - CuttingOver
                    - HealthChecking
                    - Completed
                    - Failed
                    - RolledBack
                phaseStartedAt:
                  type: string
                  description: When the current phase started
                  format: date-time
                message:
                  type: string
                  description: Human-readable message about current state
                observedGeneration:
                  type: integer
                  description: Last observed generation
                  format: int64
                targetClusterName:
                  type: string
                  description: Name of the target cluster being created
                targetClusterReady:
                  type: boolean
                  description: Whether the target cluster is ready
                sourceVersion:
                  type: string
                  description: PostgreSQL version of source cluster
                startedAt:
                  type: string
                  description: When the upgrade started
                  format: date-time
                completedAt:
                  type: string
                  description: When the upgrade completed
                  format: date-time
                cutoverStartedAt:
                  type: string
                  description: When cutover began
                  format: date-time
                replication:
                  type: object
                  description: Replication status
                  properties:
                    status:
                      type: string
                      description: Current replication state
                      enum:
                        - NotConfigured
                        - Syncing
                        - Active
                        - Synced
                        - Stopped
                        - Error
                    sourceLsn:
                      type: string
                      description: Current LSN on source
                    targetLsn:
                      type: string
                      description: Current LSN on target
                    lagBytes:
                      type: integer
                      description: Replication lag in bytes
                      format: int64
                    lagSeconds:
                      type: integer
                      description: Replication lag in seconds
                      format: int64
                    lsnInSync:
                      type: boolean
                      description: Whether LSN positions are in sync
                    lastSyncTime:
                      type: string
                      description: Last time replication was checked
                      format: date-time
                    publicationName:
                      type: string
                      description: Name of the publication on source
                    subscriptionName:
                      type: string
                      description: Name of the subscription on target
                verification:
                  type: object
                  description: Row count verification status
                  properties:
                    lastCheckTime:
                      type: string
                      description: Last verification check time (RFC3339 format)
                      format: date-time
                    tablesVerified:
                      type: integer
                      description: Number of tables verified
                      format: int32
                    tablesMatched:
                      type: integer
                      description: Number of tables with matching row counts
                      format: int32
                    tablesMismatched:
                      type: integer
                      description: Number of tables with mismatched row counts
                      format: int32
                    consecutivePasses:
                      type: integer
                      description: Number of consecutive successful verification passes
                      format: int32
                    mismatchedTables:
                      type: array
                      description: Details of tables with row count mismatches
                      items:
                        type: object
                        properties:
                          schema:
                            type: string
                            description: Schema name
                          table:
                            type: string
                            description: Table name
                          sourceCount:
                            type: integer
                            description: Row count in source
                            format: int64
                          targetCount:
                            type: integer
                            description: Row count in target
                            format: int64
                          difference:
                            type: integer
                            description: Difference (source - target)
                            format: int64
                sequences:
                  type: object
                  description: Sequence sync status
                  properties:
                    synced:
                      type: boolean
                      description: Whether sequences are synced
                    totalSequences:
                      type: integer
                      description: Total number of sequences
                    syncedCount:
                      type: integer
                      description: Number of sequences synced
                    failedCount:
                      type: integer
                      description: Number of sequences that failed to sync
                    syncedAt:
                      type: string
                      description: When sequences were synced
                      format: date-time
                rollback:
                  type: object
                  description: Rollback status and feasibility
                  properties:
                    feasible:
                      type: boolean
                      description: Whether rollback is currently feasible
                    reason:
                      type: string
                      description: Reason for rollback feasibility
                    dataLossRisk:
                      type: boolean
                      description: Whether rollback would risk data loss
                    triggeredAt:
                      type: string
                      description: When rollback was triggered
                      format: date-time
                    completedAt:
                      type: string
                      description: When rollback completed
                      format: date-time
                conditions:
                  type: array
                  description: Conditions representing the current state
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                        description: Type of condition
                      status:
                        type: string
                        description: Status of the condition (True, False, Unknown)
                      lastTransitionTime:
                        type: string
                        description: Last time the condition transitioned
                        format: date-time
                      reason:
                        type: string
                        description: Human-readable reason for the condition
                      message:
                        type: string
                        description: Human-readable message
