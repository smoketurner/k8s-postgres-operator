apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: postgresclusters.postgres-operator.smoketurner.com
spec:
  group: postgres-operator.smoketurner.com
  names:
    kind: PostgresCluster
    listKind: PostgresClusterList
    plural: postgresclusters
    singular: postgrescluster
    shortNames:
      - pgc
    categories:
      - databases
      - postgresql
      - all
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Version
          type: string
          jsonPath: .spec.version
        - name: Replicas
          type: integer
          jsonPath: .spec.replicas
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Ready
          type: integer
          jsonPath: .status.readyReplicas
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            spec:
              type: object
              required:
                - version
                - storage
              x-kubernetes-validations:
                # PostgreSQL version format validation
                - rule: "self.version.matches('^[0-9]{1,2}(\\\\.[0-9]+)?$')"
                  message: "version must be a valid PostgreSQL version (e.g., '15', '16', '15.4')"
                # Storage size format validation (Kubernetes quantity)
                - rule: "self.storage.size.matches('^[0-9]+(\\\\.[0-9]+)?(Ki|Mi|Gi|Ti|Pi|Ei|k|M|G|T|P|E)?$')"
                  message: "storage.size must be a valid Kubernetes quantity (e.g., '10Gi', '500Mi')"
                # Replica count validation
                # 1 replica: development/testing
                # 2 replicas: primary + read replica (no automatic failover)
                # 3+ replicas: full HA with automatic failover
                - rule: "self.replicas >= 1"
                  message: "replicas must be at least 1"
              properties:
                version:
                  type: string
                  description: PostgreSQL version (e.g., "15", "16")
                  # Pattern provides basic validation; CEL rule above provides better error messages
                  pattern: "^[0-9]{1,2}(\\.[0-9]+)?$"
                replicas:
                  type: integer
                  description: |
                    Number of Patroni members in the cluster:
                    - 1: single server
                    - 2: primary + 1 read replica
                    - 3+: highly available cluster
                  minimum: 1
                  maximum: 100
                  default: 1
                storage:
                  type: object
                  required:
                    - size
                  properties:
                    storageClass:
                      type: string
                      description: Storage class name
                    size:
                      type: string
                      description: Size of the persistent volume
                resources:
                  type: object
                  properties:
                    limits:
                      type: object
                      properties:
                        cpu:
                          type: string
                        memory:
                          type: string
                    requests:
                      type: object
                      properties:
                        cpu:
                          type: string
                        memory:
                          type: string
                postgresqlParams:
                  type: object
                  additionalProperties:
                    type: string
                  description: Custom PostgreSQL configuration parameters
                labels:
                  type: object
                  additionalProperties:
                    type: string
                  description: |
                    Custom labels to apply to all resources created for this cluster.
                    Use for cost allocation, team ownership, and organizational tracking.
                    Common labels: team, cost-center, project, environment
                backup:
                  type: object
                  description: |
                    Backup configuration for continuous archiving and point-in-time recovery (PITR).
                    Uses WAL-G for continuous WAL archiving and scheduled base backups.
                  x-kubernetes-validations:
                    # If backup is configured with a destination, schedule is required
                    - rule: "!has(self.destination) || has(self.schedule)"
                      message: "backup.schedule is required when backup.destination is configured"
                  properties:
                    schedule:
                      type: string
                      description: |
                        Backup schedule in cron format (e.g., "0 2 * * *" for 2 AM daily).
                        Base backups are created on this schedule.
                        WAL archiving happens continuously regardless of this schedule.
                    retention:
                      type: object
                      description: Retention policy for backups (uses Spilo's backup retention)
                      properties:
                        count:
                          type: integer
                          description: Number of base backups to retain (uses BACKUP_NUM_TO_RETAIN)
                          minimum: 1
                        maxAge:
                          type: string
                          description: Maximum age of backups (e.g., "7d", "30d", "1w")
                    destination:
                      type: object
                      description: Cloud storage destination for backups
                      x-kubernetes-validations:
                        # S3 requires bucket, region, and credentialsSecret
                        - rule: "self.type != 'S3' || (has(self.bucket) && has(self.region) && has(self.credentialsSecret))"
                          message: "S3 backup requires bucket, region, and credentialsSecret"
                        # GCS requires bucket and credentialsSecret
                        - rule: "self.type != 'GCS' || (has(self.bucket) && has(self.credentialsSecret))"
                          message: "GCS backup requires bucket and credentialsSecret"
                        # Azure requires container, storageAccount, and credentialsSecret
                        - rule: "self.type != 'Azure' || (has(self.container) && has(self.storageAccount) && has(self.credentialsSecret))"
                          message: "Azure backup requires container, storageAccount, and credentialsSecret"
                      required:
                        - type
                      properties:
                        type:
                          type: string
                          description: Cloud storage type
                          enum:
                            - S3
                            - GCS
                            - Azure
                        bucket:
                          type: string
                          description: Bucket name for S3 or GCS
                        region:
                          type: string
                          description: AWS region for S3 (e.g., "us-east-1")
                        endpoint:
                          type: string
                          description: Custom S3-compatible endpoint URL (for MinIO, etc.)
                        container:
                          type: string
                          description: Azure blob container name
                        storageAccount:
                          type: string
                          description: Azure storage account name
                        credentialsSecret:
                          type: string
                          description: |
                            Name of secret containing cloud credentials.
                            For S3: AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY (optional: AWS_SESSION_TOKEN)
                            For GCS: GOOGLE_APPLICATION_CREDENTIALS (service account JSON)
                            For Azure: AZURE_STORAGE_ACCESS_KEY or AZURE_STORAGE_SAS_TOKEN
                        path:
                          type: string
                          description: Path prefix within the bucket/container (default is namespace/cluster-name)
                        disableSse:
                          type: boolean
                          description: Disable S3 server-side encryption
                          default: false
                        forcePathStyle:
                          type: boolean
                          description: Force path-style URLs for S3 (required for some S3-compatible storage)
                          default: false
                        environment:
                          type: string
                          description: Azure environment name (e.g., "AzurePublicCloud")
                    walArchiving:
                      type: object
                      description: WAL archiving configuration (enabled by default when backup is configured)
                      properties:
                        enabled:
                          type: boolean
                          description: Enable WAL archiving
                          default: true
                        restoreTimeout:
                          type: integer
                          description: Timeout for WAL restore operations in seconds (0 to disable)
                          minimum: 0
                    encryption:
                      type: object
                      description: |
                        Backup encryption configuration (REQUIRED for security).
                        All backups must be encrypted at rest to protect sensitive data.
                        The presence of this section enables encryption.
                      required:
                        - keySecret
                      properties:
                        method:
                          type: string
                          description: Encryption method
                          enum:
                            - aes256
                            - pgp
                          default: aes256
                        keySecret:
                          type: string
                          description: |
                            Secret containing encryption key.
                            For AES: expects key named 'encryption-key'
                            For PGP: expects key named 'pgp-key'
                    compression:
                      type: string
                      description: Compression method for backups
                      enum:
                        - lz4
                        - lzma
                        - brotli
                        - zstd
                        - none
                      default: lz4
                    backupFromReplica:
                      type: boolean
                      description: Take backups from replica instead of primary (reduces primary load)
                      default: false
                    uploadConcurrency:
                      type: integer
                      description: Number of concurrent upload streams
                      minimum: 1
                      maximum: 64
                      default: 16
                    downloadConcurrency:
                      type: integer
                      description: Number of concurrent download streams for restore
                      minimum: 1
                      maximum: 64
                      default: 10
                    enableDeltaBackups:
                      type: boolean
                      description: Enable delta backups (only changed pages since last backup)
                      default: false
                    deltaMaxSteps:
                      type: integer
                      description: Maximum delta backup steps before forcing full backup
                      minimum: 1
                      maximum: 10
                      default: 3
                pgbouncer:
                  type: object
                  description: PgBouncer connection pooler configuration (deployed as separate Deployment)
                  x-kubernetes-validations:
                    # If PgBouncer is enabled, pool settings should be reasonable
                    - rule: "!self.enabled || !has(self.maxClientConn) || self.maxClientConn >= 10"
                      message: "pgbouncer.maxClientConn should be at least 10 when enabled"
                    - rule: "!self.enabled || !has(self.defaultPoolSize) || self.defaultPoolSize >= 1"
                      message: "pgbouncer.defaultPoolSize must be at least 1 when enabled"
                  properties:
                    enabled:
                      type: boolean
                      description: Enable PgBouncer connection pooler (deployed as separate Deployment)
                    replicas:
                      type: integer
                      description: Number of PgBouncer replicas
                      minimum: 1
                      maximum: 10
                      default: 2
                    poolMode:
                      type: string
                      description: Connection pool mode
                      enum:
                        - session
                        - transaction
                        - statement
                      default: transaction
                    maxDbConnections:
                      type: integer
                      description: Total max database connections distributed across all instances
                      minimum: 1
                      maximum: 10000
                      default: 60
                    defaultPoolSize:
                      type: integer
                      description: Default pool size per user/database pair
                      minimum: 1
                      maximum: 1000
                      default: 20
                    maxClientConn:
                      type: integer
                      description: Maximum client connections per PgBouncer instance
                      minimum: 10
                      maximum: 100000
                      default: 10000
                    image:
                      type: string
                      description: PgBouncer container image (default bitnami/pgbouncer)
                    resources:
                      type: object
                      description: Resource requirements for PgBouncer pods
                      properties:
                        limits:
                          type: object
                          properties:
                            cpu:
                              type: string
                            memory:
                              type: string
                        requests:
                          type: object
                          properties:
                            cpu:
                              type: string
                            memory:
                              type: string
                    enableReplicaPooler:
                      type: boolean
                      description: Enable separate connection pooler for read replicas
                      default: false
                tls:
                  type: object
                  description: |
                    TLS configuration for encrypted connections.
                    TLS is enabled by default for security. Requires cert-manager to be installed.
                  properties:
                    enabled:
                      type: boolean
                      description: Enable TLS for PostgreSQL connections (default true)
                      default: true
                    issuerRef:
                      type: object
                      description: Reference to a cert-manager Issuer or ClusterIssuer for certificate provisioning
                      properties:
                        name:
                          type: string
                          description: Name of the Issuer or ClusterIssuer
                        kind:
                          type: string
                          description: Kind of issuer (Issuer or ClusterIssuer)
                          enum:
                            - Issuer
                            - ClusterIssuer
                          default: ClusterIssuer
                        group:
                          type: string
                          description: API group of the issuer (default cert-manager.io)
                          default: cert-manager.io
                      required:
                        - name
                    additionalDnsNames:
                      type: array
                      description: Additional DNS names to include in the certificate
                      items:
                        type: string
                    duration:
                      type: string
                      description: Certificate validity duration (e.g., "2160h" for 90 days)
                    renewBefore:
                      type: string
                      description: Time before expiry to renew certificate (e.g., "360h" for 15 days)
                metrics:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                    port:
                      type: integer
                service:
                  type: object
                  description: Service configuration for external access
                  x-kubernetes-validations:
                    - rule: "!has(self.nodePort) || self.type == 'NodePort'"
                      message: "nodePort is only valid when service type is NodePort"
                    - rule: "!has(self.loadBalancerSourceRanges) || self.type == 'LoadBalancer'"
                      message: "loadBalancerSourceRanges is only valid when service type is LoadBalancer"
                    - rule: "!has(self.externalTrafficPolicy) || self.type == 'NodePort' || self.type == 'LoadBalancer'"
                      message: "externalTrafficPolicy is only valid for NodePort or LoadBalancer service types"
                  properties:
                    type:
                      type: string
                      description: "Service type: ClusterIP (default), NodePort, or LoadBalancer"
                      enum:
                        - ClusterIP
                        - NodePort
                        - LoadBalancer
                      default: ClusterIP
                    annotations:
                      type: object
                      additionalProperties:
                        type: string
                      description: Annotations to add to the services
                    loadBalancerSourceRanges:
                      type: array
                      items:
                        type: string
                      description: CIDR ranges allowed to access LoadBalancer
                    externalTrafficPolicy:
                      type: string
                      description: External traffic policy (Cluster or Local)
                      enum:
                        - Cluster
                        - Local
                    nodePort:
                      type: integer
                      description: NodePort for PostgreSQL port (only for NodePort type)
                      minimum: 30000
                      maximum: 32767
                scaling:
                  type: object
                  description: |
                    Auto-scaling configuration for the cluster.
                    Requires KEDA to be installed in the cluster.
                  properties:
                    minReplicas:
                      type: integer
                      description: |
                        Minimum number of replicas.
                        Set to 0 to enable scale-to-zero for development clusters.
                        Default: spec.replicas (no scale-down below desired)
                      minimum: 0
                    maxReplicas:
                      type: integer
                      description: Maximum number of replicas
                      minimum: 1
                      default: 10
                    idleTimeout:
                      type: string
                      description: |
                        Time without connections before scaling to minReplicas.
                        Format: duration string (e.g., "30m", "1h").
                        Default: 30m
                      default: "30m"
                    wakeupTimeout:
                      type: string
                      description: |
                        Maximum time to wait for cluster wake-up on connection attempt.
                        Only applies when minReplicas=0 (scale-to-zero).
                        Default: 5m
                      default: "5m"
                    replicationLagThreshold:
                      type: string
                      description: |
                        Replication lag threshold for reader service routing.
                        Replicas exceeding this threshold are excluded from the reader service.
                        Format: duration string (e.g., "30s", "1m").
                        Default: 30s
                      default: "30s"
                    metrics:
                      type: object
                      description: Scaling metrics configuration
                      properties:
                        cpu:
                          type: object
                          description: CPU-based scaling configuration
                          properties:
                            targetUtilization:
                              type: integer
                              description: Target CPU utilization percentage (0-100)
                              minimum: 1
                              maximum: 100
                              default: 70
                        connections:
                          type: object
                          description: Connection-based scaling configuration
                          properties:
                            targetPerReplica:
                              type: integer
                              description: Target active connections per replica
                              minimum: 1
                              default: 100
                networkPolicy:
                  type: object
                  description: |
                    Network policy configuration for the cluster.
                    Controls which pods and namespaces can connect to the PostgreSQL cluster.
                  properties:
                    allowExternalAccess:
                      type: boolean
                      description: |
                        Allow connections from RFC1918 private IP ranges (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16).
                        Use for development/testing environments.
                        Default: false (secure by default)
                      default: false
                    allowFrom:
                      type: array
                      description: |
                        List of additional sources allowed to connect to the cluster.
                        Useful for cross-namespace access.
                      items:
                        type: object
                        properties:
                          namespaceSelector:
                            type: object
                            description: Selects namespaces using labels
                            properties:
                              matchLabels:
                                type: object
                                additionalProperties:
                                  type: string
                                description: Labels that namespaces must have to be allowed
                              matchExpressions:
                                type: array
                                items:
                                  type: object
                                  properties:
                                    key:
                                      type: string
                                    operator:
                                      type: string
                                      enum: [In, NotIn, Exists, DoesNotExist]
                                    values:
                                      type: array
                                      items:
                                        type: string
                          podSelector:
                            type: object
                            description: Selects pods within selected namespaces
                            properties:
                              matchLabels:
                                type: object
                                additionalProperties:
                                  type: string
                                description: Labels that pods must have to be allowed
                              matchExpressions:
                                type: array
                                items:
                                  type: object
                                  properties:
                                    key:
                                      type: string
                                    operator:
                                      type: string
                                      enum: [In, NotIn, Exists, DoesNotExist]
                                    values:
                                      type: array
                                      items:
                                        type: string
            status:
              type: object
              properties:
                phase:
                  type: string
                  enum:
                    - Pending
                    - Creating
                    - Running
                    - Updating
                    - Scaling
                    - Degraded
                    - Failed
                    - Recovering
                    - Hibernating
                    - Deleting
                readyReplicas:
                  type: integer
                replicas:
                  type: integer
                primaryPod:
                  type: string
                replicaPods:
                  type: array
                  items:
                    type: string
                backup:
                  type: object
                  description: Backup status information
                  properties:
                    enabled:
                      type: boolean
                      description: Whether backups are currently configured and enabled
                    destinationType:
                      type: string
                      description: Backup destination type (S3, GCS, Azure)
                    lastBackupTime:
                      type: string
                      description: Timestamp of the last successful base backup (RFC3339)
                    lastBackupSizeBytes:
                      type: integer
                      format: int64
                      description: Size of the last backup in bytes
                    lastBackupName:
                      type: string
                      description: Name/ID of the last backup
                    oldestBackupTime:
                      type: string
                      description: Timestamp of the oldest available backup (RFC3339)
                    backupCount:
                      type: integer
                      description: Number of available base backups
                    lastWalArchived:
                      type: string
                      description: Last WAL file archived successfully
                    lastWalArchiveTime:
                      type: string
                      description: Time of last WAL archive (RFC3339)
                    walArchivingHealthy:
                      type: boolean
                      description: Whether WAL archiving is healthy
                    lastError:
                      type: string
                      description: Last backup error message, if any
                    lastErrorTime:
                      type: string
                      description: Time of last error (RFC3339)
                    recoveryWindowStart:
                      type: string
                      description: Point-in-time recovery window start (oldest recoverable point)
                    recoveryWindowEnd:
                      type: string
                      description: Point-in-time recovery window end (most recent recoverable point)
                observedGeneration:
                  type: integer
                  format: int64
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      reason:
                        type: string
                      message:
                        type: string
                      lastTransitionTime:
                        type: string
                      observedGeneration:
                        type: integer
                        format: int64
                retryCount:
                  type: integer
                  description: Current retry count for exponential backoff
                lastError:
                  type: string
                  description: Last error message encountered during reconciliation
                lastErrorTime:
                  type: string
                  description: Timestamp of the last error
                previousReplicas:
                  type: integer
                  description: Previous replica count (used for tracking scaling operations)
                phaseStartedAt:
                  type: string
                  description: Timestamp when the current phase started (RFC3339 format)
                currentVersion:
                  type: string
                  description: Current PostgreSQL version running in the cluster (used to prevent downgrades)
                tlsEnabled:
                  type: boolean
                  description: Whether TLS is currently enabled on the cluster
                pgbouncerEnabled:
                  type: boolean
                  description: Whether PgBouncer pooler is currently enabled
                pgbouncerReadyReplicas:
                  type: integer
                  description: Number of ready PgBouncer replicas
                replicationLag:
                  type: array
                  description: Replication lag information for each replica pod
                  items:
                    type: object
                    properties:
                      podName:
                        type: string
                        description: Name of the replica pod
                      lagBytes:
                        type: integer
                        format: int64
                        description: Replication lag in bytes
                      lagTime:
                        type: string
                        description: Replication lag as duration string
                      exceedsThreshold:
                        type: boolean
                        description: Whether this replica exceeds the configured lag threshold
                      lastMeasured:
                        type: string
                        description: Last time the lag was measured (RFC3339)
                      state:
                        type: string
                        description: Replication state (streaming, catchup, etc.)
                maxReplicationLagBytes:
                  type: integer
                  format: int64
                  description: Maximum replication lag across all replicas (in bytes)
                replicasLagging:
                  type: boolean
                  description: Whether any replica exceeds the configured lag threshold
