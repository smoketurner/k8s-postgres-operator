apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: postgresclusters.postgres.example.com
spec:
  group: postgres.example.com
  names:
    kind: PostgresCluster
    listKind: PostgresClusterList
    plural: postgresclusters
    singular: postgrescluster
    shortNames:
      - pgc
  scope: Namespaced
  versions:
    - name: v1alpha1
      served: true
      storage: true
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Version
          type: string
          jsonPath: .spec.version
        - name: Replicas
          type: integer
          jsonPath: .spec.replicas
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Ready
          type: integer
          jsonPath: .status.readyReplicas
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
      schema:
        openAPIV3Schema:
          type: object
          required:
            - spec
          properties:
            spec:
              type: object
              required:
                - version
                - storage
              properties:
                version:
                  type: string
                  description: PostgreSQL version (e.g., "15", "16")
                replicas:
                  type: integer
                  description: |
                    Number of Patroni members in the cluster:
                    - 1: single server
                    - 2: primary + 1 read replica
                    - 3+: highly available cluster
                  minimum: 1
                  maximum: 100
                  default: 1
                storage:
                  type: object
                  required:
                    - size
                  properties:
                    storageClass:
                      type: string
                      description: Storage class name
                    size:
                      type: string
                      description: Size of the persistent volume
                resources:
                  type: object
                  properties:
                    limits:
                      type: object
                      properties:
                        cpu:
                          type: string
                        memory:
                          type: string
                    requests:
                      type: object
                      properties:
                        cpu:
                          type: string
                        memory:
                          type: string
                postgresqlParams:
                  type: object
                  additionalProperties:
                    type: string
                  description: Custom PostgreSQL configuration parameters
                backup:
                  type: object
                  properties:
                    schedule:
                      type: string
                      description: Backup schedule in cron format
                    retention:
                      type: object
                      properties:
                        count:
                          type: integer
                        maxAge:
                          type: string
                    destination:
                      type: object
                      properties:
                        type:
                          type: string
                          enum:
                            - S3
                            - GCS
                            - Azure
                        bucket:
                          type: string
                        region:
                          type: string
                        endpoint:
                          type: string
                        container:
                          type: string
                        storageAccount:
                          type: string
                        credentialsSecret:
                          type: string
                pgbouncer:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                    poolMode:
                      type: string
                      enum:
                        - session
                        - transaction
                        - statement
                    maxClientConn:
                      type: integer
                    defaultPoolSize:
                      type: integer
                tls:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                    certSecret:
                      type: string
                    caSecret:
                      type: string
                metrics:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                    port:
                      type: integer
            status:
              type: object
              properties:
                phase:
                  type: string
                  enum:
                    - Pending
                    - Creating
                    - Running
                    - Updating
                    - Failed
                    - Deleting
                readyReplicas:
                  type: integer
                replicas:
                  type: integer
                primaryPod:
                  type: string
                replicaPods:
                  type: array
                  items:
                    type: string
                lastBackup:
                  type: string
                observedGeneration:
                  type: integer
                  format: int64
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      reason:
                        type: string
                      message:
                        type: string
                      lastTransitionTime:
                        type: string
                      observedGeneration:
                        type: integer
                        format: int64
